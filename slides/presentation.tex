\documentclass{beamer}

\newcommand{\email}[1]{\texttt{#1}}

\title{mqtt-locust}
\author[Bentley, Mason]
{
    M. Bentley \and A. Mason\\
    \email{\{void,null\}@case.edu}
}
\institute[CWRU]{Case Western Reserve University}

\begin{document}
\frame{\titlepage}

\begin{frame}
    \frametitle{Locust}
    \begin{enumerate}
        \item Load testing framework written in Python
        \item
            Distributed model out of the box
            \begin{enumerate}
                \item Can be run in master-slave configuration to put your
                machines under even higher load
            \end{enumerate}
        \item
            Butâ€¦ only supports HTTP out of the box
            \begin{enumerate}
                \item Can be extended for any protocol by writing a client that
                fires success/failure events
            \end{enumerate}
    \end{enumerate}
\end{frame}

\begin{frame}
    \frametitle{Extending locust to support MQTT}
    \begin{enumerate}
        \item Fairly easy to do.
        \item Focused mainly on \texttt{publish} behavior, but would be easy to
        add other user behaviors (e.g. \texttt{subscribe} and verify a message
        was received).
        \item
            Other tools for load-testing mqtt brokers:
            \begin{enumerate}
                \item
                    \href{https://github.com/leandog/mqtt-malaria}{mqtt-malaria}
                    \begin{enumerate}
                        \item However, mqtt-malaria only scales horizontally to
                        the number of cores on a single machine. Using locust
                        will allow us to scale our testing to many machines.
                    \end{enumerate}
            \end{enumerate}
    \end{enumerate}
\end{frame}

\begin{frame}
    \frametitle{Issues}
    \begin{enumerate}
        \item
            Overwhelming the broker with too many connections.
            \begin{enumerate}
                \item Each ``user'' would open it`s own connection to the
                broker. So, to send $n$ messages simltaneously, we would need
                $n$ simultaneous connections to the broker. This significantly
                limited the amount we could scale mqtt-locust.
                \item Solution: Override the \texttt{publish} method to take a
                \texttt{repeat} keyword argument. Each ``user'' would then send
                \texttt{repeat} messages. This way, we can send the same number
                of messages with fewer connections to the broker.
            \end{enumerate}
    \end{enumerate}
\end{frame}

\begin{frame}
    \frametitle{Issues}
    \begin{enumerate}
        \item
            Tracking messages. Python threads and stuff.
            \begin{enumerate}
                \item To track messages, we store them in a dictionary, and
                then use the underlying \texttt{on\_publish} method to fire the
                various locust events.
                \item But, as load increases, messages get published faster
                than \texttt{on\_publish} can enumerate the dictionary. Python
                then complains that the size of the dictionary is changing
                during enumeration.
                \item Solution: Using \texttt{dict(mmap)}, we get a copy of the
                dictionary, which we can then enumerate safely. This operation
                completes quickly enough that we don't get the previous error.
            \end{enumerate}
    \end{enumerate}
\end{frame}

\begin{frame}
    \frametitle{mqtt-locust results}
    % TODO
\end{frame}

\begin{frame}
    \frametitle{mqtt-locust vs mqtt-malaria}
    % TODO
\end{frame}

\begin{frame}
    \frametitle{Future Work and Goals}
    \begin{enumerate}
        \item
            Clean up connections on close.
        \item
            Handle disconnecting and reconnecting cleanly.
            \begin{enumerate}
                \item
            \end{enumerate}
        \item
            Should error upon double-receiving a message. Or, at least log a
            warning.
            \begin{enumerate}
                \item
            \end{enumerate}
        \item
            Submit to upstream locust to have it included by default.
    \end{enumerate}
\end{frame}

\begin{frame}
    \frametitle{Conclusion}
    % TODO
\end{frame}
\end{document}
